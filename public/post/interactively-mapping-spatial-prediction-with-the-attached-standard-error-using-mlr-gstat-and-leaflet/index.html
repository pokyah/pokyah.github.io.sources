<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="author" content="Thomas Goossens">
<meta name="description" content="Here we demonstrate how to map the prediction together with the uncertainty in an intuitive and intelligible way. Our approach is based on this post by Tomislav Hengl and this post by Penn state college of earth and mineral sciences
# For the example, using the output of mlr gstat KED from previous section # loading datasets data(meuse) data(meuse.grid) # imputing values to missing data meuse = impute(meuse, classes = list(numeric = imputeMean(), factor = imputeMode()), dummy.">

<meta property="og:title" content="Interactively-Mapping-Spatial-Prediction-With-the-Attached-Standard-Error-Using-Mlr-Gstat-and-Leaflet" />
<meta property="og:description" content="Here we demonstrate how to map the prediction together with the uncertainty in an intuitive and intelligible way. Our approach is based on this post by Tomislav Hengl and this post by Penn state college of earth and mineral sciences
# For the example, using the output of mlr gstat KED from previous section # loading datasets data(meuse) data(meuse.grid) # imputing values to missing data meuse = impute(meuse, classes = list(numeric = imputeMean(), factor = imputeMode()), dummy." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/interactively-mapping-spatial-prediction-with-the-attached-standard-error-using-mlr-gstat-and-leaflet/" />



<meta property="article:published_time" content="2018-07-20T12:52:41&#43;00:00"/>

<meta property="article:modified_time" content="2018-07-20T12:52:41&#43;00:00"/>












<title>


     Interactively-Mapping-Spatial-Prediction-With-the-Attached-Standard-Error-Using-Mlr-Gstat-and-Leaflet 

</title>
<link rel="canonical" href="../../post/interactively-mapping-spatial-prediction-with-the-attached-standard-error-using-mlr-gstat-and-leaflet/">







<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/tomorrow.min.css">




<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Ubuntu+Mono:400,400i,700,700i|Raleway:500">



    
    <link rel="stylesheet" href="../../css/reset.css?t=2018-08-23%2013%3a37%3a29.905693207%20%2b0000%20UTC%20m%3d%2b0.161210506">
    <link rel="stylesheet" href="../../css/pygments.css?t=2018-08-23%2013%3a37%3a29.905693207%20%2b0000%20UTC%20m%3d%2b0.161210506">
    <link rel="stylesheet" href="../../css/main.css?t=2018-08-23%2013%3a37%3a29.905693207%20%2b0000%20UTC%20m%3d%2b0.161210506">
    
        <link rel="stylesheet" href="../../css/override.css?t=2018-08-23%2013%3a37%3a29.905693207%20%2b0000%20UTC%20m%3d%2b0.161210506">
    




<link rel="shortcut icon"

    href="../../img/leaf.ico"

>








</head>


<body lang="">

<section class="header">
    <div class="container">
        <div class="content">
            
            <a href="../../"><img class="avatar" src="https://gravatar.com/avatar/813fa5a73b53880ab30a635a6e807e9a?s=50" rcset="https://gravatar.com/avatar/813fa5a73b53880ab30a635a6e807e9a?s=100 2x, https://gravatar.com/avatar/813fa5a73b53880ab30a635a6e807e9a?s=150 3x, https://gravatar.com/avatar/813fa5a73b53880ab30a635a6e807e9a?s=200 4x"></a>
            
            <a href="../../"><div class="name">Thomas Goossens</div></a>
            
              <h3 class="self-intro">Geographer/Data-analyst/Coder</h3>
            
            <nav>
                <ul>
                    
                        <li class="nav-post"><a href="../../post/"><span>blog</span></a></li>
                    
                        <li class="nav-about"><a href="../../about/"><span>About</span></a></li>
                    
                        <li class="nav-code"><a href="../../code/"><span>Code</span></a></li>
                    
                        <li class="nav-blogroll"><a href="../../blogroll/"><span>Blogroll</span></a></li>
                    
                        <li class="nav-cv"><a href="../../cv/"><span>CV</span></a></li>
                    
                        <li class="nav-geo-tools"><a href="../../geo-tools/"><span>Geo-Tools</span></a></li>
                    
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
        
            <a href="//stackoverflow.com/pokyah" target="_blank" rel="noopener"><img class="icon" src="../../img/stack-overflow.svg" alt="stackoverflow" /></a>          
          
        
            <a href="//open.spotify.com/user/pokyah?si=P6TQ1j6tQRWJN1sqTKDAEA" target="_blank" rel="noopener"><img class="icon" src="../../img/spotify.svg" alt="spotify" /></a>
          
        
            <a href="//github.com/pokyah" target="_blank" rel="noopener"><img class="icon" src="../../img/github.svg" alt="github" /></a>
        

        

	

        

        

        
            <a href="//linkedin.com/in/thomasgoossens1985" target="_blank" rel="noopener"><img class="icon" src="../../img/linkedin.svg" alt="linkedin" /></a>
        

        

        

        

        

        
            <a href="mailto:hello.pokyah@gmail.com"><img class="icon" src="../../img/email.svg" alt="email" /></a>
        

        

        
        </div>
    </div>
</section>


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    Interactively-Mapping-Spatial-Prediction-With-the-Attached-Standard-Error-Using-Mlr-Gstat-and-Leaflet

</div>

                    <div class="initials"><a href="../../">ad</a></div>
                </div>
                <div class="meta">
                    
                    <div class="date" title='Fri Jul 20 2018 12:52:41 UTC'>Jul 20, 2018</div>
                    
                    
		    <div class="reading-time"><div class="middot"></div>4 minutes read</div>
                    
                </div>
            </div>
            <div class="markdown">
                <p>Here we demonstrate how to map the prediction together with the uncertainty in an intuitive and intelligible way. Our approach is based on <a href="http://spatial-analyst.net/wiki/index.php/Uncertainty_visualization#Visualization_of_uncertainty_using_whitening_in_R">this</a> post by <em>Tomislav Hengl</em> and <a href="https://www.e-education.psu.edu/geog486/node/1891">this</a> post by <em>Penn state college of earth and mineral sciences</em></p>
<pre class="r"><code># For the example, using the output of mlr gstat KED from previous section
# loading datasets
data(meuse)
data(meuse.grid)
# imputing values to missing data
meuse = impute(meuse, classes = list(numeric = imputeMean(), factor = imputeMode()),
  dummy.classes = &quot;integer&quot;)$data
meuse.grid = impute(meuse.grid, classes = list(numeric = imputeMean(), factor = imputeMode()),
  dummy.classes = &quot;integer&quot;)$data
# adding a column with log zinc
meuse = meuse %&gt;% dplyr::mutate(log_zinc = log(zinc))
# adding a column with sqrt dist
meuse = meuse %&gt;% dplyr::mutate(sqrt_dist = sqrt(dist))
meuse.grid = meuse.grid %&gt;% dplyr::mutate(sqrt_dist = sqrt(dist))
# defining the regression task
task = makeRegrTask(id = &quot;meuse&quot;,  data = meuse, target = &quot;log_zinc&quot;)
task.krg = dropFeatures(task = task, features = getTaskFeatureNames(task)[-c(1,2,15)])
# defining the learner
lrn.krg = makeLearner(cl = &quot;regr.gstat&quot;, id = &quot;ln(zn) mlr kriging with external drift&quot;, predict.type = &quot;response&quot;, psill = 1, model = &quot;Exp&quot;, range = 300, nugget = 1, locations = ~x+y) 
# training the model
mod.krg = train(lrn.krg, task.krg)
# kriging
newdata.pred.krg = predict(object = mod.krg, newdata = meuse.grid)
mlr.krg = bind_cols(data.frame(meuse.grid), newdata.pred.krg$data)
# mapping
coordinates(mlr.krg) = ~x+y
gridded(mlr.krg) = TRUE
pred.plot = spplot(mlr.krg[&quot;response&quot;], do.log = T, colorkey = TRUE, main = mod.krg$learner$id)
# SE - defining the standard error learner by altering the previous one.
se.lrn.krg = setPredictType(lrn.krg, predict.type = &quot;se&quot;)
# training the SE model
se.mod.krg = train(se.lrn.krg, task.krg)
# SE kriging
se.newdata.pred.krg = predict(object = se.mod.krg, newdata = meuse.grid)
se.mlr.krg = bind_cols(data.frame(meuse.grid), se.newdata.pred.krg$data)

# mapping with leaflet

# loading the required libraries
library(leaflet)
library(dplyr)
library(htmltools)
library(sf)

# defining the function to create a palette of different levels of alpha for the choosen color 
alphaPal = function(color) {
  alpha = seq(0,1,0.1)
  r = col2rgb(color, alpha=T)
  r = t(apply(r, 1, rep, length(alpha)))
  # Apply alpha
  r[4,] = alpha*255
  r = r/255.0
  codes = (rgb(r[1,], r[2,], r[3,], r[4,]))
  return(codes)
}

# keeping what we need 
interpolated.df = se.mlr.krg %&gt;% select(one_of(c(&quot;x&quot;,&quot;y&quot;,&quot;response&quot;,&quot;se&quot;)))
# making it spatial object class sf
interpolated.sf = st_as_sf(interpolated.df,coords = c(&quot;x&quot;,&quot;y&quot;))
# defining the crs
st_crs(interpolated.sf) = 28992 # found at https://rdrr.io/cran/sp/man/meuse.html
# transforming to geographic CRS (EPSG = 4326)
interpolated.sf = st_transform(interpolated.sf, crs = 4326)
# Now we need to inject this point info into polygon centered arounds the points to fake a raster layer but which is interactive
class(mlr.krg) # SpatialPixelsDataFrame
# making the gridded mlr.krg a raster 
grid.r = raster::raster(mlr.krg, values=TRUE)
# convert raster to polygons
grid.sp = raster::rasterToPolygons(grid.r, dissolve = F)
class(grid.sp) # SpatialPolygonsDataFrame
# converting to sf for later joining
grid.sf = st_as_sf(grid.sp)
st_crs(grid.sf) = 28992 # found at https://rdrr.io/cran/sp/man/meuse.html
# transforming to geographic CRS (EPSG = 4326)
grid.sf = st_transform(grid.sf, crs = 4326)
# injecting the prediction and se data into the polygon grid doing a spatial join
# interpolated.sf = st_join(grid.sf, interpolated.sf) %&gt;% select(one_of(c(&quot;response&quot;, &quot;se&quot;)))
interpolated.pg.sf = dplyr::bind_cols(grid.sf, interpolated.sf)
interpolated.pg.sf = interpolated.pg.sf %&gt;% select(one_of(c(&quot;response&quot;, &quot;se&quot;)))
# Do we have polygons ? 
head(interpolated.pg.sf)

# defining the function to map using leaflet
leafletize = function(data.sf){
  # to make the map responsive
  responsiveness.chr = &quot;\&#39;&lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1.0\&quot;&gt;\&#39;&quot;
  
  # defining the color palette for the response
  varPal = colorNumeric(
    palette = &quot;Spectral&quot;,
    domain = data.sf$response
  )
  
  # defining the transparent colorpal for the se
  uncPal = colorNumeric(
    palette = alphaPal(&quot;#e6e6e6&quot;),
    domain = data.sf$se,
    alpha = TRUE
  )

  # 
  prediction.map = leaflet::leaflet(data.sf) %&gt;%
    addProviderTiles(group = &quot;Stamen&quot;,
                     providers$Stamen.Toner,
                     options = providerTileOptions(opacity = 0.25)
    ) %&gt;%
    addProviderTiles(group = &quot;Satellite&quot;,
                     providers$Esri.WorldImagery,
                     options = providerTileOptions(opacity = 1)
    ) %&gt;%
    fitBounds(sf::st_bbox(data.sf)[[1]],
              sf::st_bbox(data.sf)[[2]],
              sf::st_bbox(data.sf)[[3]],
              sf::st_bbox(data.sf)[[4]]
    ) %&gt;%
    addLayersControl(baseGroups = c(&quot;Stamen&quot;, &quot;Satellite&quot;),
                     overlayGroups = c(&quot;prediction&quot;, &quot;se&quot;),
                     options = layersControlOptions(collapsed = TRUE)
    ) %&gt;%
    addEasyButton(easyButton(
      icon=&quot;fa-crosshairs&quot;, title=&quot;Locate Me&quot;,
      onClick=JS(&quot;function(btn, map){ map.locate({setView: true}); }&quot;))) %&gt;%
    htmlwidgets::onRender(paste0(&quot;
                                 function(el, x) {
                                 $(&#39;head&#39;).append(&quot;,responsiveness.chr,&quot;);
                                 }&quot;)
    ) %&gt;%
    addPolygons(
                group = &quot;prediction&quot;,
                color = &quot;#444444&quot;, stroke = FALSE, weight = 1, smoothFactor = 0.5,
                opacity = 1.0, fillOpacity = 0.9,
                fillColor = ~varPal(response),
                highlightOptions = highlightOptions(color = &quot;white&quot;, weight = 2,
                                                    bringToFront = TRUE)
    )%&gt;%
    addLegend(
              position = &quot;bottomright&quot;, pal = varPal, values = ~response,
              title = &quot;prediction&quot;,
              group = &quot;prediction&quot;,
              opacity = 1
    )%&gt;%
    addPolygons(
                group = &quot;se&quot;,
                color = &quot;#444444&quot;, stroke = FALSE, weight = 1, smoothFactor = 0.5,
                opacity = 1.0, fillOpacity = 1,
                fillColor = ~uncPal(se),
                highlightOptions = highlightOptions(color = &quot;white&quot;, weight = 2,
                                                    bringToFront = TRUE),
                label = ~ paste(&quot;prediction:&quot;, signif(data.sf$response, 2), &quot;\n&quot;,&quot;se: &quot;, signif(data.sf$se, 2))
    ) %&gt;%
    addLegend(
              group = &quot;se&quot;,
              position = &quot;bottomleft&quot;, pal = uncPal, values = ~se,
              title = &quot;se&quot;,
              opacity = 1
    )
  return(prediction.map)
}
# create the map object
prediction.map = leafletize(interpolated.pg.sf)

# render it
html = list(h3(paste0(&quot;interactive prediction map&quot;)),
                 prediction.map 
                 )
tagList(html)</code></pre>

     
                
                  <div class="tags">
                    <strong>Tags:</strong>
                    <ul>
                  
                    <li>
                      <a href="../../tags/how-to">how-to</a>
                    </li>  
                  
                    <li>
                      <a href="../../tags/code">code</a>
                    </li>  
                  
                  </ul>
                  </div>
                  
                
                <br>
                
                  <div class="tags">
                    <strong>Categories:</strong>
                    <ul>
                  
                    <li>
                      <a href="../../categories/r">r</a>
                    </li>
                  
                    <li>
                      <a href="../../categories/geomatic">geomatic</a>
                    </li>
                  
                  </ul>
                  </div>
                  <br />
                
                <p class="back-to-posts"><a href="../../post/">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "pokyah-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            
        </div>
    </div>
</section>



<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-123-45', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/go.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/r.min.js"></script>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/languages/bash.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>





</body>
</html>

